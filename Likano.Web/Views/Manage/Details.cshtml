@model Likano.Web.Models.Manage.ProductDetailsViewModel
@using Likano.Domain.Enums

@{
    ViewData["Title"] = "პროდუქტის დეტალები";

    var product = Model.Product;
    var categories = Model.Categories;
    var brands = Model.Brands;
    var countries = Model.Countries;

 
    var typeText = product?.ProductType switch
    {
        ProductType.BuiltIn => "ჩასაშენებელი",
        ProductType.Freestanding => "დასადგამი",
        ProductType.WallMounted => "კედელზე დასაკიდი",
        ProductType.CounterTop => "ზედაპირზე / მაგიდაზე დასადგამი",
        ProductType.FloorMounted => "იატაკზე დასადგამი",
        _ => "—"
    };
    var statusText = product?.Status switch
    {
        ProductStatus.Active => "აქტიური",
        ProductStatus.Hiden => "დამალული",
        ProductStatus.Deleted => "წაშლილი",
        _ => "—"
    };

    var statusClass = product?.Status switch
    {
        ProductStatus.Active => "bg-success",
        ProductStatus.Hiden => "bg-warning",
        ProductStatus.Deleted => "bg-danger",
        _ => "bg-secondary"
    };
}

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0 text-primary fw-bold">პროდუქტის დეტალები</h2>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm rounded-4" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm rounded-4" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (product == null || product.Success == false)
    {
        <div class="alert alert-danger shadow-sm rounded-4">
            <i class="fas fa-exclamation-triangle me-2"></i>
            @product?.Message ?? "პროდუქტის დეტალების ჩატვირთვა ვერ მოხერხდა."
        </div>
        return;
    }

    <div class="card shadow border-0 rounded-4 overflow-hidden">
        <div class="card-header bg-gradient-primary text-white py-3">
            <h5 class="mb-0">
                <i class="fas fa-box-open me-2"></i>ID: @product.Id – @product.Title
            </h5>
        </div>

        <div class="card-body p-4">
            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="text-center">
                        @if (!string.IsNullOrWhiteSpace(product.ImageUrl))
                        {
                            <img src="@product.ImageUrl" alt="@product.Title"
                                 class="img-fluid rounded shadow-sm"
                                 style="max-height: 400px; width: 100%; object-fit: cover;" />
                        }
                        else
                        {
                            <div class="bg-light rounded d-flex align-items-center justify-content-center shadow-sm"
                                 style="height: 400px;">
                                <i class="fas fa-image text-muted fa-5x opacity-50"></i>
                            </div>
                        }
                    </div>
                </div>

                <div class="col-lg-8">
                    <h4 class="fw-bold text-dark mb-3">@product.Title</h4>

                    <div class="mb-4">
                        <p class="text-muted">
                            @if (!string.IsNullOrWhiteSpace(product.Description))
                            {
                                @product.Description
                            }
                            else
                            {
                                <em>აღწერა არ არის მითითებული</em>
                            }
                        </p>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex">
                                <strong class="text-muted me-3" style="min-width: 120px;">ფასი:</strong>
                                <span class="fw-bold text-primary h5 mb-0">
                                    @(product.Price.HasValue ? $"{product.Price:0.##} ₾" : "—")
                                </span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <strong class="text-muted me-3" style="min-width: 120px;">ბრენდი:</strong>
                                    <span>@(string.IsNullOrWhiteSpace(product.BrandTitle) ? "—" : product.BrandTitle)</span>
                                </div>
                                <button type="button"
                                        class="btn btn-outline-primary btn-sm"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#changeBrandPanel"
                                        aria-expanded="false"
                                        aria-controls="changeBrandPanel">
                                    <i class="fas fa-exchange-alt me-1"></i>ბრენდის შეცვლა
                                </button>
                            </div>

                            <div id="changeBrandPanel" class="collapse mt-2">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body py-3">
                                        <form asp-controller="Manage" asp-action="ChangeProductBrand" method="post" class="row g-3">
                                            <input type="hidden" name="productId" value="@product.Id" />
                                            <div class="col-12 col-md-8">
                                                <label for="newBrandId" class="form-label fw-medium mb-1">ახალი ბრენდი</label>
                                                <select id="newBrandId" name="newBrandId" class="form-select form-select-sm" required style="min-height: 32px;">
                                                    <option value="">-- აირჩიეთ ბრენდი --</option>
                                                    @foreach (var b in brands)
                                                    {
                                                        if (b.Id == product.BrandId)
                                                        {
                                                            <option value="@b.Id" selected>@b.Name</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@b.Id">@b.Name</option>
                                                        }
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-12 col-md-4">
                                                <div class="d-flex flex-wrap gap-2">
                                                    <button type="submit" class="btn btn-success btn-sm flex-grow-1">
                                                        <i class="fas fa-check me-1"></i>დადასტურება
                                                    </button>
                                                    <button type="button"
                                                            class="btn btn-secondary btn-sm flex-grow-1"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#changeBrandPanel">
                                                        <i class="fas fa-times me-1"></i>გაუქმება
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <strong class="text-muted me-3" style="min-width: 120px;">კატეგორია:</strong>
                                    <span>@(string.IsNullOrWhiteSpace(product.CategoryTitle) ? "—" : product.CategoryTitle)</span>
                                </div>
                                <button type="button"
                                        class="btn btn-outline-primary btn-sm"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#changeCategoryPanel"
                                        aria-expanded="false"
                                        aria-controls="changeCategoryPanel">
                                    <i class="fas fa-exchange-alt me-1"></i>კატეგორიის შეცვლა
                                </button>
                            </div>

                            <div id="changeCategoryPanel" class="collapse mt-2">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body py-3">
                                        <form asp-controller="Manage" asp-action="ChangeProductCategory" method="post" class="row g-3">
                                            <input type="hidden" name="productId" value="@product.Id" />
                                            <div class="col-12 col-md-8">
                                                <label for="newCategoryId" class="form-label fw-medium mb-1">ახალი კატეგორია</label>
                                                <select id="newCategoryId" name="newCategoryId" class="form-select form-select-sm" required style="min-height: 32px;">
                                                    <option value="">-- აირჩიეთ კატეგორია --</option>
                                                    @foreach (var c in categories)
                                                    {
                                                        if (c.Id == product.CategoryId)
                                                        {
                                                            <option value="@c.Id" selected>@c.Name</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@c.Id">@c.Name</option>
                                                        }
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-12 col-md-4">
                                                <div class="d-flex flex-wrap gap-2">
                                                    <button type="submit" class="btn btn-success btn-sm flex-grow-1">
                                                        <i class="fas fa-check me-1"></i>დადასტურება
                                                    </button>
                                                    <button type="button"
                                                            class="btn btn-secondary btn-sm flex-grow-1"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#changeCategoryPanel">
                                                        <i class="fas fa-times me-1"></i>გაუქმება
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex">
                                <strong class="text-muted me-3" style="min-width: 120px;">ხელმისაწვდომია:</strong>
                                <span class="badge @(product.IsAvailable == true ? "bg-success" : "bg-secondary") px-3 py-2">
                                    @(product.IsAvailable == true ? "კი" : "არა")
                                </span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex">
                                <strong class="text-muted me-3" style="min-width: 120px;">სტატუსი:</strong>
                                <span class="badge rounded-pill @statusClass px-3 py-2">
                                    @statusText
                                </span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex">
                                <strong class="text-muted me-3" style="min-width: 120px;">შექმნის თარიღი:</strong>
                                <span>@(product.CreateDate?.ToString("dd.MM.yyyy HH:mm") ?? "—")</span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex">
                                <strong class="text-muted me-3" style="min-width: 120px;">განახლების თარიღი:</strong>
                                <span>@(product.UpdateDate?.ToString("dd.MM.yyyy HH:mm") ?? "—")</span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex">
                                <strong class="text-muted me-3" style="min-width: 120px;">მასალა:</strong>
                                <span>@(string.IsNullOrWhiteSpace(product.Material) ? "—" : product.Material)</span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex">
                                <strong class="text-muted me-3" style="min-width: 120px;">კოდი:</strong>
                                <span>@(string.IsNullOrWhiteSpace(product.Code) ? "—" : product.Code)</span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex">
                                <strong class="text-muted me-3" style="min-width: 120px;">SEO TITLE:</strong>
                                <span>@(string.IsNullOrWhiteSpace(product.SeoTitle) ? "—" : product.SeoTitle)</span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex">
                                <strong class="text-muted me-3" style="min-width: 120px;">ფერი:</strong>
                                <span>@(string.IsNullOrWhiteSpace(product.Color) ? "—" : product.Color)</span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex">
                                <strong class="text-muted me-3" style="min-width: 120px;">კომპლექტაცია:</strong>
                                <span>
                                    @(string.IsNullOrWhiteSpace(product.IncludedComponents) ? "—" : product.IncludedComponents)
                                </span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex">
                                <strong class="text-muted me-3" style="min-width: 120px;">სიგრძე:</strong>
                                <span>@(product.Length.HasValue ? $"{product.Length:0.##} სმ" : "—")</span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex">
                                <strong class="text-muted me-3" style="min-width: 120px;">სიგანე:</strong>
                                <span>@(product.Width.HasValue ? $"{product.Width:0.##} სმ" : "—")</span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex">
                                <strong class="text-muted me-3" style="min-width: 120px;">სიმაღლე:</strong>
                                <span>@(product.Height.HasValue ? $"{product.Height:0.##} სმ" : "—")</span>
                            </div>
                        </div>

                        <div class="col-md-6">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <strong class="text-muted me-3" style="min-width: 120px;">ტიპი:</strong>
            <span class="badge rounded-pill @statusClass px-3 py-2">
                @typeText
            </span>
        </div>
        <button type="button"
                class="btn btn-outline-primary btn-sm"
                data-bs-toggle="collapse"
                data-bs-target="#changeTypePanel"
                aria-expanded="false"
                aria-controls="changeTypePanel">
            <i class="fas fa-exchange-alt me-1"></i>ტიპის შეცვლა
        </button>
    </div>

    <div id="changeTypePanel" class="collapse mt-2">
        <div class="card border-0 shadow-sm">
            <div class="card-body py-3">
                <form asp-controller="Manage" asp-action="ChangeProductType" method="post" class="row g-3">
                    <input type="hidden" name="productId" value="@product.Id" />
                    <div class="col-12 col-md-8">
                        <label for="newType" class="form-label fw-medium mb-1">ახალი ტიპი</label>
                        <select id="newType" name="newType" class="form-select form-select-sm" required style="min-height: 32px;">
                            <option value="">-- აირჩიეთ ტიპი --</option>
                                                    @foreach (ProductType pt in Enum.GetValues(typeof(ProductType)))
                                                    {
                                                        <option value="@( (int)pt )" selected="@(product.ProductType == pt)">
                                                            @(
                                                              pt switch
                                                              {
                                                               ProductType.BuiltIn => "ჩასაშენებელი",
                                                               ProductType.Freestanding => "დასადგამი",
                                                               ProductType.WallMounted => "კედელზე დასაკიდი",
                                                               ProductType.CounterTop => "ზედაპირზე / მაგიდაზე დასადგამი",
                                                               ProductType.FloorMounted => "იატაკზე დასადგამი",
                                                               _ => pt.ToString()
                                                               }
                                                                )
                                                    </option>
            }

                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="d-flex flex-wrap gap-2">
                            <button type="submit" class="btn btn-success btn-sm flex-grow-1">
                                <i class="fas fa-check me-1"></i>დადასტურება
                            </button>
                            <button type="button"
                                    class="btn btn-secondary btn-sm flex-grow-1"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#changeTypePanel">
                                <i class="fas fa-times me-1"></i>გაუქმება
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <strong class="text-muted me-3" style="min-width: 120px;">მწარმოებელი ქვეყანა:</strong>
                                    <span>@(string.IsNullOrWhiteSpace(product.ProducerCountryName) ? "—" : product.ProducerCountryName)</span>
                                </div>
                                <button type="button"
                                        class="btn btn-outline-primary btn-sm"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#changeCountryPanel"
                                        aria-expanded="false"
                                        aria-controls="changeCountryPanel">
                                    <i class="fas fa-exchange-alt me-1"></i>ქვეყნის შეცვლა
                                </button>
                            </div>

                            <div id="changeCountryPanel" class="collapse mt-2">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body py-3">
                                        <form asp-controller="Manage" asp-action="ChangeProductCountry" method="post" class="row g-3">
                                            <input type="hidden" name="productId" value="@product.Id" />
                                            <div class="col-12 col-md-8">
                                                <label for="newCountryId" class="form-label fw-medium mb-1">ახალი ქვეყანა</label>
                                                <select id="newCountryId" name="newCountryId" class="form-select form-select-sm" required style="min-height: 32px;">
                                                    <option value="">-- აირჩიეთ ქვეყანა --</option>
                                                    @foreach (var country in countries)
                                                    {
                                                        if (country.Id == product.ProducerCountryId)
                                                        {
                                                            <option value="@country.Id" selected>@country.Name</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@country.Id">@country.Name</option>
                                                        }
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-12 col-md-4">
                                                <div class="d-flex flex-wrap gap-2">
                                                    <button type="submit" class="btn btn-success btn-sm flex-grow-1">
                                                        <i class="fas fa-check me-1"></i>დადასტურება
                                                    </button>
                                                    <button type="button"
                                                            class="btn btn-secondary btn-sm flex-grow-1"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#changeCountryPanel">
                                                        <i class="fas fa-times me-1"></i>გაუქმება
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="mb-4">
                        <h5 class="fw-bold text-dark mb-3">სტატუსის მართვა</h5>
                        <div class="d-flex flex-wrap gap-2">
                            @switch (product.Status)
                            {
                                case ProductStatus.Active:
                                    <form asp-action="ChangeProductStatus" method="post" class="d-inline">
                                        <input type="hidden" name="productId" value="@product.Id" />
                                        <input type="hidden" name="status" value="@ProductStatus.Hiden" />
                                        <button type="submit" class="btn btn-warning shadow-sm"
                                                onclick="return confirm('ნამდვილად გსურთ პროდუქტის დამალვა?')">
                                            <i class="fas fa-eye-slash me-2"></i>დამალვა
                                        </button>
                                    </form>
                                    <form asp-action="ChangeProductStatus" method="post" class="d-inline">
                                        <input type="hidden" name="productId" value="@product.Id" />
                                        <input type="hidden" name="status" value="@ProductStatus.Deleted" />
                                        <button type="submit" class="btn btn-danger shadow-sm"
                                                onclick="return confirm('ნამდვილად გსურთ პროდუქტის წაშლა?')">
                                            <i class="fas fa-trash me-2"></i>წაშლა
                                        </button>
                                    </form>
                                    break;
                                case ProductStatus.Hiden:
                                    <form asp-action="ChangeProductStatus" method="post" class="d-inline">
                                        <input type="hidden" name="productId" value="@product.Id" />
                                        <input type="hidden" name="status" value="@ProductStatus.Active" />
                                        <button type="submit" class="btn btn-success shadow-sm"
                                                onclick="return confirm('ნამდვილად გინდათ პროდუქტის გამოჩენა?')">
                                            <i class="fas fa-eye me-2"></i>გამოჩენა
                                        </button>
                                    </form>
                                    <form asp-action="ChangeProductStatus" method="post" class="d-inline">
                                        <input type="hidden" name="productId" value="@product.Id" />
                                        <input type="hidden" name="status" value="@ProductStatus.Deleted" />
                                        <button type="submit" class="btn btn-danger shadow-sm"
                                                onclick="return confirm('ნამდვილად გსურთ პროდუქტის წაშლა?')">
                                            <i class="fas fa-trash me-2"></i>წაშლა
                                        </button>
                                    </form>
                                    break;
                                case ProductStatus.Deleted:
                                    <form asp-action="ChangeProductStatus" method="post" class="d-inline">
                                        <input type="hidden" name="productId" value="@product.Id" />
                                        <input type="hidden" name="status" value="@ProductStatus.Active" />
                                        <button type="submit" class="btn btn-success shadow-sm"
                                                onclick="return confirm('ნამდვილად გსურთ პროდუქტის აღდგენა?')">
                                            <i class="fas fa-undo me-2"></i>აღდგენა
                                        </button>
                                    </form>
                                    break;
                            }
                        </div>
                    </div>
                    <form asp-controller="Manage" asp-action="ChangeProductAvailableStatus" method="post">
                        <input type="hidden" name="productId" value="@Model.Product.Id" />
                        <input type="hidden" name="intoGrid" value="false" />
                        <input type="hidden" name="isAvailable" value="@(Model.Product.IsAvailable == true ? "false" : "true")" />
                        <button type="submit" class="btn btn-warning">
                            @(Model.Product.IsAvailable == true ? "ხელმიუწვდომელი" : "ხელმისაწვდომი")
                        </button>
                    </form>

                    <hr class="my-4">

                    <div class="text-end">
                        @if (product.Status != ProductStatus.Deleted)
                        {
                            <a asp-controller="Manage" asp-action="EditProduct" asp-route-id="@product.Id"
                               class="btn btn-outline-primary shadow-sm me-2">
                                <i class="fas fa-edit me-2"></i>რედაქტირება
                            </a>
                        }
                        <a asp-controller="Home" asp-action="ProductDetails" asp-route-id="@product.Id"
                           class="btn btn-outline-success shadow-sm me-2" target="_blank">
                            <i class="fas fa-external-link-alt me-2"></i> ნახვა ვებ-გვერდზე
                        </a>

                        <a asp-controller="Manage" asp-action="Products"
                           class="btn btn-secondary shadow-sm">
                            <i class="fas fa-arrow-left me-2"></i>უკან დაბრუნება
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }

        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card {
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .badge {
            font-size: 0.9rem;
        }

        #changeCategoryPanel .card-body {
            overflow: visible;
        }
    </style>

    @section Scripts {
        <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    }
</div>